<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../gold-email-input/gold-email-input.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../polymerfire/firebase.html">
<link rel="import" href="../polymerfire/firebase-common-behavior.html">
<link rel="import" href="../polymerfire/paper-styles/paper-styles.html">
<link rel="import" href="../polymerfire/paper-icon-button/paper-icon-button.html">


<!--
A form for selecting a firebase authentication provider and displaying input elements that are relevant for that provider.

The element fires a `login` event when the user decides to login.

NOTE: You will need to have your provider settings in order before you can succesfully use the external providers for login. https://firebase.google.com/docs/auth/

Usage:

<material-sign-in-form password-provider-button-label="Log in!"></material-sign-in-form>

@demo demo/material-sign-in-form_test.html
-->
<dom-module id="material-sign-in-form">
    <template>
        <style>
        :host {
          display: block;
        }

        paper-button {
          color:white;
          margin:10px 0px;
          text-align:center;
        }

        #login-button {
          margin-top:40px;
          width:100%;
          background-color: var(--paper-blue-500);
        }

        #oauth-providers {
          margin-top:30px;
          @apply(--layout-horizontal);
          @apply(--layout-center-justified);
        }

        paper-icon-button {
          border:1px solid var(--paper-grey-200);
          margin:0px 5px;
          @apply(--layout-flex);
          height:50px;
          border-radius: 3px;
        }

        h1 {
          text-align:center;
          font-size: 20px;
          font-weight:normal;
          margin:0px;
        }

        #login-division {
          @apply(--layout-horizontal);
          margin-top:50px;
        }

        gold-email-input {
          margin-top:30px;
        }

        #forgot-password {
          color: var(--paper-blue-500);
          height:35px;
        }

        p {
          text-align:center;
        }

        hr {
          @apply(--layout-flex);
          border: 0;
          border-top: 1px solid black;
          margin:6px 10px;
        }

        </style>


        <p>
          <h1>Howdy! Login below</h1>
        </p>



        <section id="password-provider">


          <gold-email-input label="E-mail address" value="{{email}}" on-keypress="_keyPressed" invalid="{{_emailInvalid}}" auto-validate ></gold-email-input>


          <paper-input label="Password" value="{{password}}" type="password"  on-keypress="_keyPressed" auto-validate>

            <paper-button id="forgot-password" suffix on-tap="requestResetPassword">I forgot</paper-button>
          </paper-input>

          <paper-button id="login-button" signInButton on-tap="signInWithPassword"  on-keypress="_keyPressed" disabled="{{!inputsValid}}">Login</paper-button>

          <p hidden$="{{!errorMessage}}">
              {{errorMessage}}

          </p>

            <div id="login-division">
              <p>
                <hr>
                Or login through
                <hr>
              </p>
            </div>

            <section id="oauth-providers">

                <paper-icon-button src="/images/icon-co-facebook.svg" id="facebook-button" signInButton on-tap="signInWithFacebook"  on-keypress="_keyPressed">Login with Facebook</paper-icon-button>

                <paper-icon-button src="/images/icon-co-google.svg" id="google-button" signInButton on-tap="signInWithGoogle"  on-keypress="_keyPressed">Login with Google</paper-icon-button>

                <paper-icon-button src="/images/icon-co-github.svg" id="github-button" signInButton on-tap="signInWithGithub"  on-keypress="_keyPressed">Login with Github</paper-icon-button>

                <paper-icon-button src="/images/icon-co-twitter.svg" id="twitter-button" signInButton on-tap="signInWithTwitter"  on-keypress="_keyPressed">Login with Twitter</paper-icon-button>

            </section>


        </section>

    </template>

    <script>
    Polymer({
        is: 'material-sign-in-form',

        properties: {
            /** E-mail address for use with the `password` provider **/
            email: {
                type: String,
                notify: true,
                value: ''
            },
            /** Password for use with the `password` provider **/
            password: {
                type: String,
                notify: true,
                value: ''
            },
            /** Both the e-mail and the password are filled in */
            inputsValid: {
                type: Boolean,
                computed: '_emailAndPasswordValid(email, _emailInvalid, password)',
                value: false
            },
            /** Both the e-mail and the password are filled in */
            errorMessage: {
                type: String,
                value: null,
                readOnly: true
            },
            _emailInvalid: Boolean,
        },


        requestResetPassword: function () {
            this._setErrorMessage(null)
            if (this.email && !this._emailInvalid) return this.fire('request-reset-password', {email: this.email})
            return this._setErrorMessage('Please enter a valid e-mail address')
        },

        /** Fire the `signIn` event with provider `github` */
        signInWithGithub: function () {
            var github = new firebase.auth.GithubAuthProvider()
            return this.signIn(github)
        },

        /** Fire the `signIn` event with provider `google` */
        signInWithGoogle: function () {
            var google = new firebase.auth.GoogleAuthProvider()
            return this.signIn(google)
        },

        /** Fire the `signIn` event with provider `facebook` */
        signInWithFacebook: function () {
            var facebook = new firebase.auth.FacebookAuthProvider()
            return this.signIn(facebook)
        },

        /** Fire the `signIn` event with provider `twitter` */
        signInWithTwitter: function () {
            var twitter = new firebase.auth.TwitterAuthProvider()
            return this.signIn(twitter)
        },

        /** Fire the `signIn` event with provider `password` and the email and password in the options */
        signInWithPassword: function () {
            return this.signIn('password', {
                email: this.email,
                password: this.password
            })
        },

        /**
        * Non bubling, to signal the need for a signIn.
        *
        * @event signIn
        */

        /**
        * Fire the `signIn` event
        *
        * @param {string} provider can be any valid Firebase authentication provider.
        * @param {object} options object of the options to fire with the event, becomes event detail.
        */
        signIn: function (provider, options) {
            this._setErrorMessage(null)
            return this.fire('sign-in', {
                provider: provider,
                options: options
            }, {
                bubbles: false
            })
        },

        /**
        * Set the error message to display
        */
        error: function (error) {
            if (error.code === "auth/invalid-email") {
                return this._setErrorMessage('Invalid e-mail address')
            }
            if (error.code === "auth/wrong-password") {
                return this._setErrorMessage('Invalid password')
            }
            if (error.code === "auth/user-not-found") {
                return this._setErrorMessage('Account does not exist')
            }
            if (error.code === "auth/user-disabled") {
                return this._setErrorMessage('Application not authorized with provider')
            }
            if (error.code === "auth/app-not-authorized") {
                return this._setErrorMessage('Provider error')
            }
            if (error.code === "auth/network-request-failed") {
                return this._setErrorMessage('Network error')
            }
            if (error.code === "auth/weak-password") {
                return this._setErrorMessage('Please provide a stronger password')
            }
            return this._setErrorMessage('Error')
        },

        _emailAndPasswordValid: function (email, emailInvalid, password) {
            return (email !== '' && password !== '' && emailInvalid === false)
        },

        _keyPressed: function(e) {
            if (e.keyCode == 13 && !e.shiftKey && this.inputsValid === true) {
                this.signInWithPassword();
            }
        },
    });
    </script>
</dom-module>
