<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../gold-email-input/gold-email-input.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../app-localize-behavior/app-localize-behavior.html">

<!--
A form for selecting a firebase authentication provider and displaying input elements that are relevant for that provider.

The element fires a `login` event when the user decides to login.

Usage:

    <material-sign-in-form password-provider-button-label="Log in!"></material-sign-in-form>

@demo demo/material-sign-in-form.html
-->
<dom-module id="material-sign-in-form">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <section id="oauth-providers">
      <p>{{localize('signInWithProviderDescription')}}</p>
      <ul>
        <li><paper-button on-tap="signInWithGithub">GitHub</paper-button></li>
        <li><paper-button on-tap="signInWithGoogle">Google</paper-button></li>
        <li><paper-button on-tap="signInWithFacebook">Facebook</paper-button></li>
        <li><paper-button on-tap="signInWithTwitter">Twitter</paper-button></li>
      </ul>
    </section>

    <section id="password-provider">
      <p>{{localize('signInWithPasswordDescription')}}</p>
      <gold-email-input label="{{localize('emailInputLabel')}}" value="{{email}}" auto-validate invalid="{{_emailInvalid}}"></gold-email-input>
      <paper-input label="{{localize('passwordInputLabel')}}" value="{{password}}" type="password" auto-validate></paper-input>
      <paper-button on-tap="signInWithPassword" disabled="{{!inputsValid}}">{{localize('passwordProviderButtonLabel')}}</paper-button>
      <p hidden$="{{!localize(errorType)}}">
        {{localize(errorType)}}
      </p>
    </section>
  </template>
  <script>
    Polymer({
      is: 'material-sign-in-form',

      behaviors: [
        Polymer.AppLocalizeBehavior
      ],

      properties: {
        /** E-mail address for use with the `password` provider **/
        email: {
          type: String,
          notify: true,
          value: ''
        },
        /** Password for use with the `password` provider **/
        password: {
          type: String,
          notify: true,
          value: ''
        },
        /** Log in with password button label */
        passwordProviderButtonLabel: {
          type: String,
          value: 'Sign in'
        },
        /** E-mail field label */
        emailInputLabel: {
          type: String,
          value: 'E-mail address'
        },
        /** Password field label */
        passwordInputLabel: {
          type: String,
          value: 'Password'
        },
        /** Both the e-mail and the password are filled in */
        inputsValid: {
          type: Boolean,
          computed: '_emailAndPasswordValid(email, _emailInvalid, password)',
          value: false
        },
        /** Both the e-mail and the password are filled in */
        errorType: {
          type: String,
          value: null,
          readOnly: true
        },
        language: {
          value: 'en'
        },
        _emailInvalid: Boolean,
      },

      /** Fire the `signIn` event with provider `github` */
      signInWithGithub: function () {
        return this.signIn('github')
      },
      /** Fire the `signIn` event with provider `google` */
      signInWithGoogle: function () {
        return this.signIn('google')
      },
      /** Fire the `signIn` event with provider `facebook` */
      signInWithFacebook: function () {
        return this.signIn('facebook')
      },
      /** Fire the `signIn` event with provider `twitter` */
      signInWithTwitter: function () {
        return this.signIn('twitter')
      },

      /** Fire the `signIn` event with provider `password` and the email and password in the options */
      signInWithPassword: function () {
        return this.signIn('password', {
          email: this.email,
          password: this.password
        })
      },

      /**
      * Non bubling, to signal the need for a signIn.
      *
      * @event signIn
      */

      /**
      * Fire the `signIn` event
      *
      * @param {string} provider can be any valid Firebase authentication provider.
      * @param {object} options object of the options to fire with the event, becomes event detail.
      */
      signIn: function (provider, options) {
        this._setErrorType(null)
        return this.fire('sign-in', {
          provider: provider,
          options: options
        }, {
          bubbles: false
        })
      },

      /**
      * Set the error message to display
      */
      error: function (error) {
        if (error.code === "auth/invalid-email") {
          return this._setErrorType('invalidEmailError')
        }
        if (error.code === "auth/wrong-password") {
          return this._setErrorType('invalidPasswordError')
        }
        if (error.code === "auth/user-not-found"	) {
          return this._setErrorType('userDoesNotExistError')
        }
        if (error.code === "auth/user-disabled"	) {
          return this._setErrorType('userDisabledError')
        }
        if (error.code === "auth/app-not-authorized") {
          return this._setErrorType('applicationNotAuthorizedWithProviderError')
        }
        if (error.code === "auth/network-request-failed") {
          return this._setErrorType('networkError')
        }
        return this._setErrorType('genericError')
      },

      _emailAndPasswordValid: function (email, emailInvalid, password) {
        return (email !== '' && password !== '' && emailInvalid === false)
      },

      attached: function() {
        this.loadResources(this.resolveUrl('locales.json'));
      },
    });
  </script>
</dom-module>
