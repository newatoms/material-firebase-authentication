<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-button/paper-button.html">

<link rel="import" href="../polymerfire/firebase-auth.html">
<link rel="import" href="material-sign-in-form.html">
<link rel="import" href="../polymerfire/firebase.html">
<link rel="import" href="../polymerfire/firebase-common-behavior.html">

<!--
Material design application to handle Firebase authentication, sign up and all of its related usecases.

The element consists of several pages to handle different aspects of the authentication process.

Usage:

    <material-firebase-authentication page="signup"></material-firebase-authentication>

@demo demo/material-firebase-authentication.html
-->
<dom-module id="material-firebase-authentication">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <firebase-auth id="auth"
                   signed-in="{{signedIn}}"
                   user="{{user}}"
                   on-error="_handleAuthError"
                   app="{{app}}"></firebase-auth>

    <iron-pages selected="{{page}}" attr-for-selected="data-page">
      <section data-page="signIn">
        <material-sign-in-form on-sign-in="_signInFormSignInHandler" on-request-reset-password="_requestResetPassword"></material-sign-in-form>
      </section>
      <section data-page="signup">
        <h2>Sign Up</h2>
      </section>
      <section data-page="signout">
        <h2>Sign out</h2>
        <paper-button signOutButton on-tap="signOut">Sign out</paper-button>
      </section>
    </iron-pages>
  </template>
  <script>
    Polymer({

      is: 'material-firebase-authentication',

      properties: {
        /** The current page to show, valid values are: `signIn`, `signup` */
        page: {
          type: String,
          value: 'signIn'
        },
        /** True if the client is authenticated and false if the client is not authenticated */
        signedIn: {
          type: Boolean,
          notify: true,
          value: false
        },
        /** The currently authenticated user with user-related metadata from `firebase-auth` */
        user: {
          type: Object,
          notify: true
        },
        /** The firebase app currently functioning in firebase-auth  */
        app: {
            type: Object,
            notify: true
        }
      },

      _requestResetPassword: function (evt, detail) {
        var auth = this.app.auth();
        auth.sendPasswordResetEmail(detail.email)
      },

      signOut: function (evt, detail) {
        this.$.auth.signOut()
      },

      _signInFormSignInHandler: function (evt, detail) {
        if (detail.provider === 'password' && detail.options) {
          return this.$.auth
                       .signInWithEmailAndPassword(detail.options.email, detail.options.password)
        }
        this.$.auth
              .signInWithPopup(detail.provider)
      },

      _handleAuthError: function (evt, error) {
        this.fire('error', error)
        this.querySelector('material-sign-in-form').error(error)
      },
    });
  </script>
</dom-module>
